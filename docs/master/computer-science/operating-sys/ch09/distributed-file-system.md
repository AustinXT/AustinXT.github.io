# 分布式文件系统

分布式文件系统（Distributed File System，DFS）是指建立在松散耦合的多处理机体系结构上，通过通信网络互连，将分布在本地或远程若干节点的物理存储设备以共享文件系统方式统一管理，提供给不同节点上的用户共享。DFS 的设计基于客户机/服务器模式，是一个相对独立的软件系统，被集成在分布式操作系统中。

## 分布式系统

分布式系统是基于软件实现的一种多处理机系统，是多处理机通过通信线路互连而构成的松散耦合系统，系统的处理和控制分布在各个处理机上。

- 分布式系统中的每个节点都是一台独立的计算机，并配置有完整的外部设备；
- 分布式系统中节点的耦合程度更为松散；
- 分布式系统中的每个节点可以运行不同的操作系统，每个节点拥有自己的文件系统，除了本节点的管理外，还有其他多个机构对其实施管理。

## 分布式操作系统

分布式操作系统是配置在分布式系统上的公用操作系统，以全局的方式对分布式系统中的所有资源进行统一管理，可直接对系统中地理位置分散的各种物理和逻辑资源进行动态分配和调度，有效协调和控制各个任务的并行执行，协调和保持系统内的各个计算机之间的信息传输及协作运行，并向用户提供一个统一、方便、透明的使用系统的界面和标准接口。

除了单机操作系统的功能外，还有

- 通信管理功能：提供某种通信机制使不同节点上的用户或进程能方便进行信息交换，例如提供通信原语，按照通信协议的约定和规则来实现
- 资源管理功能：对系统中的所有资源统一管理、分配和调度
- 进程管理功能：提供进程或计算的迁移，以及分布式的同步和互斥机制和应对死锁措施

## 分布式文件系统的实现方式

### 共享文件系统方式（专用服务器方式）

共享文件系统采用客户/服务器模式，设置若干个文件服务器，数据分布存储在各个文件服务器上，用一个逻辑树的结构，对整个系统中是文件系统进行管理。用户只需按照一定的逻辑关系，通过文件服务器上的服务进程，即可访问整个系统的共享资源。

### 共享磁盘方式（无服务器方式）

系统配置了一个共享磁盘（高速磁盘），并将其与主机、客户机都连接在内部的一个高速网络上，主机和客户机都将该磁盘作为他们的存储设备，直接以盘块方式读写磁盘上的文件，实现共享。

## 命名和共享语义

### 命名

命名，即在数据的逻辑对象和物理对象之间建立的映射，DFS 还需将服务器所在地址和存储方式等细节隐藏起来。

DFS 的主要命名方案有

- 结合主机名和本地名对文件进行命名，保证唯一性，例如 `host/local-name-path`
- 将若干台服务器中的远程目录，加载到客户机的本地目录中
- 全局统一命名，每个文件和目录使用唯一的命名

### 共享语义

对于 DFS，需保证多个客户机并发访问时的数据一致性，因此当多个客户共享同一个文件时，必须对客户机和服务器之间的交互协议精确处理（即精确定义读和写的语义）。

共享语义决定了多个客户共享文件的效果，应当说明被客户修改的数据何时可以被远程客户看到。

### 租赁协议

租赁协议是一个比较有代表性的一致性访问协议。

- 当客户机向服务器发送一个读请求时，会收到所请求的数据和一个租赁凭据，凭据附带一个有效期，保证服务器在该有效期内不会对客户机收到的数据进行更新（即在有效期内，客户机对数据的访问只需在本地缓存中进行）。
- 在有效期之后，客户机需要与服务器交互，确认本地缓存中的数据是否与服务器上的一致，只有确认发生了更新才需要重新向服务器请求。
- 当客户机对数据发出更新请求时，服务器需要向所有持有对该文件租赁的客户机发出更新确认（使持有的凭据无效），然后才实施更新。

## 远程文件访问和缓存

根据程序的局部性原理，DFS 引入了缓存机制，减少请求应答的传输开销。

- 缓存的粒度：粒度大了，会增加一次性传输的开销和数据一致性的开销。
- 缓存的位置：在自有主存和磁盘的客户-服务器系统中，有服务器磁盘、服务器主存、客户机磁盘和客户机主存，四个位置可用来存储文件
- 缓存的更新：选择何时用什么方式将更新写会服务器
- 数据一致性：对于本地缓存的数据副本和服务器中的主副本，客户机需要进行有效性检查，判断一致才能使用，一般有客户机发起（可以每次访问时检查，也可以定期检查）和服务器发起两种方式。

## 容错

当客户机对远程文件进行访问时，有关被访问的文件、目录和客户机的信息等，根据在服务器端是否需要进行跟踪。检查和保存等处理，可分为有状态服务（缓存客户机的有关信息）和无状态服务。

有关 DFS 的容错性环境，定义了三种文件属性

- 可恢复性：当对某个文件的操作失败，或有客户中断操作，文件能转换到原来的一致性状态。可通过更新原子操作来保证
- 坚定性：当某个存储器崩溃或存储介质损坏时，某个文件仍能保证完好。可通过设备的冗余性保证
- 可用性：无论何时（例如机器崩溃、通信失效），一旦需要就可访问。可通过文件复制（在 DFS 不同节点的主机磁盘上复制）来保证

## ChangeLog

> 2018.10.05 初稿