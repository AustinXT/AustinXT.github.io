# 多处理机系统

## 紧密耦合 MPS 和松散耦合 MPS

- 紧密耦合（Tightly Coupled）MPS：通常是通过高速总线或高速交叉开关来实现多个处理器之间的互连，操作系统对所有资源和进程实施统一控制和管理。实现方式有两种：多处理器共享主存和 I/O 设备，访问时间一般为 10~50ns；多个处理机与多个存储器或多个存储器模块分别相连，访问时间一般为 10~50us。
- 松散耦合（Loosely Coupled）MPS：通常通过通道或通信线路来实现多台计算机互连，每台计算机都有自己的存储器和 I/O 设备，并配置 OS 来管理本地资源和本地运行进程，计算机间消息传递时间一般为 10~50ms。

## UMA 多处理机系统的结构

UMA（Uniform Memory Access），即统一内存访问，各 CPU 在功能和结构上都相同（即对称多处理器系统（Symmetric Multiprocessor System）SMP），每个 CPU 都可访问不同模块中的存储器单元，且读写速度相同。

### 基于单总线的 SMP 结构

通过总线将多个 CPU 与主存相连，每个处理机可以访问不同存储器模块中的单元以及和其他存储器通信，可为每个 CPU 配置一个高速缓存。

### 使用多层总线的 SMP 结构

各 CPU 与本地私有存储器、I/O 设备通过本地总线连接，各 CPU 再通过系统总线与共享存储器连接，尽可能将所运行程序的正文、字符串、常量和其它只读数据放在其私有存储器中，仅将共享变量放在共享存储器中。

### 使用单级交叉开关的系统结构

![os_49](os_49.jpg)

将系统中所有的 CPU 与存储器节点通过交叉开关列阵互连，每列只能闭合一个交叉点开关，为并行存储访问，每行允许闭合多个交叉点开关。

### 使用多级交换网络的系统结构

![os_50](os_50.jpg)

交叉开关有两个输入和两个输出，送入的任一输入的信息可交换到任一输出，将多级交换开关分级连接起来形成多级交叉开关网络。CPU 和存储器位于网络两侧，所有处理机的访问机会均等。

## NUMA 多处理机系统结构

NUMA（Nonuniform Memory Access），即非统一内存访问，访问时间随存储字的位置不同而变化，系统中的公共存储器和分布在所有处理机的本地存储器共同构成了系统的全局地址空间，可被所有的处理机访问。

### CC-NUMA 构造方法

对于系统中每个 CPU 所拥有的若干高速缓存单元，都以一定数量的单元为一组，构成一个高速缓存快，为每个 CPU 配置一张高速缓存目录表，对每个高速缓存快的位置和状态进行记录和维护。

![os_51](os_51.jpg)

设 NUMA 拥有 N 个节点，每个节点有 n 个 CPU，通过局部总线与容量为 M 存储器相连，存储空间按长度为 K 进行划分，则每个节点的目录表包含 M/K 个表项，物理地址格式为：`| 节点号 | 块号 | 偏移量 |` 。

访问 CPUi 存储器时，先将逻辑地址转换为物理地址，根据节点号去对应节点的目录表查找对应块号内容（节点编号）。若为空，则表示本地高速缓存没有该快内容，并将存储器对应的块取出存入 CPUi 所在的节点的高速缓存，将目录表的节点修改为CPUi 所在的节点的节点号；若不为空，则将读取的节点的高速缓存取出相应的块存入CPUi 所在的节点的高速缓存并清除本地高速缓存相应的块，将目录表的节点修改为CPUi 所在的节点的节点号。

## ChangeLog

> 2018.10.03 初稿