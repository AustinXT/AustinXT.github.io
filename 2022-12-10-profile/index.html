<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>常用性能分析工具 - 夜航星</title><meta name="Description" content="做一个智能时代的蛮子"><meta property="og:url" content="https://austinxt.github.io/2022-12-10-profile/">
  <meta property="og:site_name" content="夜航星">
  <meta property="og:title" content="常用性能分析工具">
  <meta property="og:description" content="学习性能分析，最开始是查看执行时间，然后用工具帮助排查问题，用资源监控辅助。
即使您的代码能够像您期望的一样运行，但是如果它消耗了您全部的 CPU 和内存，那么它显然也不是个好程序。算法课上我们通常会介绍大 O 标记法，但却没教给我们如何找到程序中的热点。 鉴于 过早的优化是万恶之源，您需要学习性能分析和监控工具，它们会帮助您找到程序中最耗时、最耗资源的部分，这样您就可以有针对性的进行性能优化。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-12-10T00:00:00+08:00">
    <meta property="article:modified_time" content="2022-12-10T00:00:00+08:00">
    <meta property="article:tag" content="性能分析">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="常用性能分析工具">
  <meta name="twitter:description" content="学习性能分析，最开始是查看执行时间，然后用工具帮助排查问题，用资源监控辅助。
即使您的代码能够像您期望的一样运行，但是如果它消耗了您全部的 CPU 和内存，那么它显然也不是个好程序。算法课上我们通常会介绍大 O 标记法，但却没教给我们如何找到程序中的热点。 鉴于 过早的优化是万恶之源，您需要学习性能分析和监控工具，它们会帮助您找到程序中最耗时、最耗资源的部分，这样您就可以有针对性的进行性能优化。">
<meta name="application-name" content="夜航星">
<meta name="apple-mobile-web-app-title" content="夜航星">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://austinxt.github.io/2022-12-10-profile/" /><link rel="prev" href="https://austinxt.github.io/2022-11-12-shell/" /><link rel="next" href="https://austinxt.github.io/2023-01-11-data-analysis/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "常用性能分析工具",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/austinxt.github.io\/2022-12-10-profile\/"
        },"genre": "posts","keywords": "性能分析","wordcount":  4006 ,
        "url": "https:\/\/austinxt.github.io\/2022-12-10-profile\/","datePublished": "2022-12-10T00:00:00+08:00","dateModified": "2022-12-10T00:00:00+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "夜航星"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="夜航星">夜航星</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/talks/"> 呓语 </a><a class="menu-item" href="/posts/" title="文章"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="夜航星">夜航星</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/talks/" title="">呓语</a><a class="menu-item" href="/posts/" title="文章">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">常用性能分析工具</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://blog.nightvoyager.top/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>夜航星</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>知识整理</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-12-10">2022-12-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;4006 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;8 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#计时">计时</a>
      <ul>
        <li><a href="#python">Python</a>
          <ul>
            <li><a href="#shell">shell</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#性能分析工具profilers">性能分析工具（profilers）</a>
      <ul>
        <li><a href="#cpu">CPU</a>
          <ul>
            <li><a href="#python-1">Python</a>
              <ul>
                <li><a href="#按函数分析">按函数分析</a></li>
                <li><a href="#按行分析">按行分析</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#内存">内存</a>
          <ul>
            <li><a href="#c">C</a></li>
            <li><a href="#python-2">Python</a></li>
          </ul>
        </li>
        <li><a href="#事件分析">事件分析</a></li>
        <li><a href="#可视化">可视化</a>
          <ul>
            <li><a href="#采样分析器">采样分析器</a></li>
            <li><a href="#调用图">调用图</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#资源监控">资源监控</a>
      <ul>
        <li><a href="#通用监控">通用监控</a></li>
        <li><a href="#io-操作">I/O 操作</a></li>
        <li><a href="#磁盘使用">磁盘使用</a></li>
        <li><a href="#内存使用">内存使用</a></li>
        <li><a href="#打开文件">打开文件</a></li>
        <li><a href="#网络连接和配置">网络连接和配置</a></li>
        <li><a href="#网络使用">网络使用</a></li>
      </ul>
    </li>
    <li><a href="#专用工具">专用工具</a>
      <ul>
        <li><a href="#增加负载">增加负载</a></li>
        <li><a href="#基准测试">基准测试</a></li>
        <li><a href="#浏览器">浏览器</a></li>
        <li><a href="#抓包工具">抓包工具</a>
          <ul>
            <li><a href="#wireshark">Wireshark</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>学习性能分析，最开始是查看执行时间，然后用工具帮助排查问题，用资源监控辅助。</p>
<p>即使您的代码能够像您期望的一样运行，但是如果它消耗了您全部的 CPU 和内存，那么它显然也不是个好程序。算法课上我们通常会介绍大 O 标记法，但却没教给我们如何找到程序中的热点。 鉴于 <a href="http://wiki.c2.com/?PrematureOptimization" target="_blank" rel="noopener noreffer ">过早的优化是万恶之源</a>，您需要学习性能分析和监控工具，它们会帮助您找到程序中最耗时、最耗资源的部分，这样您就可以有针对性的进行性能优化。</p>
<h2 id="计时">计时</h2>
<p>和调试代码类似，大多数情况下我们只需要打印两处代码之间的时间即可发现问题。</p>
<p>通常来说，用户时间+系统时间代表了您的进程所消耗的实际 CPU （更详细的解释可以参照<a href="https://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1" target="_blank" rel="noopener noreffer ">这篇文章</a>）。</p>
<ul>
<li>真实时间 - 从程序开始到结束流失掉的真实时间，包括其他进程的执行时间以及阻塞消耗的时间（例如等待 I/O 或网络）；</li>
<li><em>User</em> - CPU 执行用户代码所花费的时间；</li>
<li><em>Sys</em> - CPU 执行系统内核代码所花费的时间。</li>
</ul>
<h3 id="python">Python</h3>
<p>下面这个例子中，我们使用了 Python 的 <a href="https://docs.python.org/3/library/time.html" target="_blank" rel="noopener noreffer "><code>time</code></a>模块。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import time, random
</span></span><span class="line"><span class="cl">n = random.randint(1, 10) * 100
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 获取当前时间 start = time.time()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 执行一些操作 print(&#34;Sleeping for {} ms&#34;.format(n))
</span></span><span class="line"><span class="cl">time.sleep(n/1000)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 比较当前时间和起始时间 print(time.time() - start)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Output
</span></span><span class="line"><span class="cl"># Sleeping for 500 ms
</span></span><span class="line"><span class="cl"># 0.5713930130004883</span></span></code></pre></div></div>
<p>也可以用 [<code>timeit</code>](<a href="https://docs.python.org/zh-cn/3/library/timeit.html" target="_blank" rel="noopener noreffer ">timeit &mdash; 测量小代码片段的执行时间 — Python 3.11.2 文档</a>) 计算一小段 Python 代码的耗时，它有   命令行接口以及一个   可调用方法。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python -m timeit -r <span class="m">10</span> -vp -n <span class="m">1000</span> -s <span class="s1">&#39;flag=&#34;-&#34;&#39;</span> <span class="s1">&#39;l=[str(i) for i in range(100)]&#39;</span> <span class="s1">&#39;flag.join(l)&#39;</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-python">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Stupid test function&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">timeit</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="s2">&#34;test()&#34;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s2">&#34;from __main__ import test&#34;</span><span class="p">))</span></span></span></code></pre></div></div>
<h4 id="shell">shell</h4>
<p>例如，试着执行一个用于发起 HTTP 请求的命令并在其前面添加 <a href="http://man7.org/linux/man-pages/man1/time.1.html" target="_blank" rel="noopener noreffer "><code>time</code></a> 前缀。网络不好的情况下您可能会看到下面的输出结果。请求花费了 2s 才完成，但是进程仅花费了 15ms 的 CPU 用户时间和 12ms 的 CPU 内核时间。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ time curl https://missing.csail.mit.edu &amp;&gt; /dev/null
</span></span><span class="line"><span class="cl">real    0m2.561s
</span></span><span class="line"><span class="cl">user    0m0.015s
</span></span><span class="line"><span class="cl">sys     0m0.012s</span></span></code></pre></div></div>
<h2 id="性能分析工具profilers">性能分析工具（profilers）</h2>
<h3 id="cpu">CPU</h3>
<p>大多数情况下，当人们提及性能分析工具的时候，通常指的是 CPU 性能分析工具。 CPU 性能分析工具有两种： 追踪分析器（<em>tracing</em>）及采样分析器（<em>sampling</em>）。 追踪分析器 会记录程序的每一次函数调用，而采样分析器则只会周期性的监测（通常为每毫秒）您的程序并记录程序堆栈。它们使用这些记录来生成统计信息，显示程序在哪些事情上花费了最多的时间。</p>
<p>另外还有，Valgrind 的 <a href="http://valgrind.org/docs/manual/cl-manual.html" target="_blank" rel="noopener noreffer ">Callgrind</a>可让你运行程序并计算所有的时间花费以及所有调用堆栈（即哪个函数调用了另一个函数）。然后，它会生成带注释的代码版本，其中包含每行花费的时间。但是，它会使程序运行速度降低一个数量级，并且不支持线程。</p>
<p>还有，用于用户程序内核跟踪的<a href="http://www.brendangregg.com/blog/2019-01-01/learn-ebpf-tracing.html" target="_blank" rel="noopener noreffer ">eBPF</a> 。如果需要低级的性能分析， <a href="https://github.com/iovisor/bpftrace" target="_blank" rel="noopener noreffer "><code>bpftrace</code></a> 值得一试。</p>
<h4 id="python-1">Python</h4>
<h5 id="按函数分析">按函数分析</h5>
<p>在 Python 中，我们使用 <code>cProfile</code> 模块来分析每次函数调用所消耗的时间。 在下面的例子中，我们实现了一个基础的 grep 命令：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">re</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">match</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;{}: {}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">times</span> <span class="o">=</span> <span class="ne">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">pattern</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></span></span></code></pre></div></div>
<p>我们可以使用下面的命令来对这段代码进行分析。通过它的输出我们可以知道，IO 消耗了大量的时间，编译正则表达式也比较耗费时间。因为正则表达式只需要编译一次，我们可以将其移动到 for 循环外面来改进性能。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ python -m cProfile -s tottime grep.py 1000 &#39;^(import|\s*def)[^,]*$&#39; *.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[omitted program output]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ncalls  tottime  percall  cumtime  percall filename:lineno(function)
</span></span><span class="line"><span class="cl">   8000    0.266    0.000    0.292    0.000 {built-in method io.open}
</span></span><span class="line"><span class="cl">   8000    0.153    0.000    0.894    0.000 grep.py:5(grep)
</span></span><span class="line"><span class="cl">  17000    0.101    0.000    0.101    0.000 {built-in method builtins.print}
</span></span><span class="line"><span class="cl">   8000    0.100    0.000    0.129    0.000 {method &#39;readlines&#39; of &#39;_io._IOBase&#39; objects}
</span></span><span class="line"><span class="cl">  93000    0.097    0.000    0.111    0.000 re.py:286(_compile)
</span></span><span class="line"><span class="cl">  93000    0.069    0.000    0.069    0.000 {method &#39;search&#39; of &#39;_sre.SRE_Pattern&#39; objects}
</span></span><span class="line"><span class="cl">  93000    0.030    0.000    0.141    0.000 re.py:231(compile)
</span></span><span class="line"><span class="cl">  17000    0.019    0.000    0.029    0.000 codecs.py:318(decode)
</span></span><span class="line"><span class="cl">      1    0.017    0.017    0.911    0.911 grep.py:3(&lt;module&gt;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[omitted lines]</span></span></code></pre></div></div>
<p>关于 Python 的 <code>cProfile</code> 分析器（以及其他一些类似的分析器），需要注意的是它显示的是每次函数调用的时间。看上去可能快到反直觉，尤其是如果您在代码里面使用了第三方的函数库，因为内部函数调用也会被看作函数调用。</p>
<h5 id="按行分析">按行分析</h5>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#!/usr/bin/env python import requests
</span></span><span class="line"><span class="cl">from bs4 import BeautifulSoup
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 这个装饰器会告诉行分析器
</span></span><span class="line"><span class="cl"># 我们想要分析这个函数
</span></span><span class="line"><span class="cl">@profile
</span></span><span class="line"><span class="cl">def get_urls():
</span></span><span class="line"><span class="cl">    response = requests.get(&#39;https://missing.csail.mit.edu&#39;)
</span></span><span class="line"><span class="cl">    s = BeautifulSoup(response.content, &#39;lxml&#39;)
</span></span><span class="line"><span class="cl">    urls = []
</span></span><span class="line"><span class="cl">    for url in s.find_all(&#39;a&#39;):
</span></span><span class="line"><span class="cl">        urls.append(url[&#39;href&#39;])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">if __name__ == &#39;__main__&#39;:
</span></span><span class="line"><span class="cl">    get_urls()</span></span></code></pre></div></div>
<p>如果我们使用 Python 的 <code>cProfile</code> 分析器，我们会得到超过 2500 行的输出结果，即使对其进行排序，我仍然搞不懂时间到底都花在哪了。如果我们使用 <a href="https://github.com/pyutils/line_profiler" target="_blank" rel="noopener noreffer "><code>line_profiler</code></a>，它会基于行来显示时间：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kernprof -l -v a.py
</span></span><span class="line"><span class="cl">Wrote profile results to urls.py.lprof
</span></span><span class="line"><span class="cl">Timer unit: 1e-06 s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total time: 0.636188 s
</span></span><span class="line"><span class="cl">File: a.py
</span></span><span class="line"><span class="cl">Function: get_urls at line 5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Line #  Hits         Time  Per Hit   % Time  Line Contents
</span></span><span class="line"><span class="cl">==============================================================
</span></span><span class="line"><span class="cl"> 5                                           @profile
</span></span><span class="line"><span class="cl"> 6                                           def get_urls():
</span></span><span class="line"><span class="cl"> 7         1     613909.0 613909.0     96.5      response = requests.get(&#39;https://missing.csail.mit.edu&#39;)
</span></span><span class="line"><span class="cl"> 8         1      21559.0  21559.0      3.4      s = BeautifulSoup(response.content, &#39;lxml&#39;)
</span></span><span class="line"><span class="cl"> 9         1          2.0      2.0      0.0      urls = []
</span></span><span class="line"><span class="cl">10        25        685.0     27.4      0.1      for url in s.find_all(&#39;a&#39;):
</span></span><span class="line"><span class="cl">11        24         33.0      1.4      0.0          urls.append(url[&#39;href&#39;])</span></span></code></pre></div></div>
<p>如果您希望了解更多相关信息，可以参考<a href="https://jvns.ca/blog/2017/12/17/how-do-ruby---python-profilers-work-" target="_blank" rel="noopener noreffer ">这篇</a> 介绍性的文章。</p>
<p>profilehooks 是一个性能测试装饰器集合。</p>
<h3 id="内存">内存</h3>
<h4 id="c">C</h4>
<p>像 C 或者 C++ 这样的语言，内存泄漏会导致您的程序在使用完内存后不去释放它。为了应对内存类的 Bug，我们可以使用类似 <a href="https://valgrind.org/" target="_blank" rel="noopener noreffer ">Valgrind</a> 这样的工具来检查内存泄漏问题。</p>
<h4 id="python-2">Python</h4>
<p>对于 Python 这类具有垃圾回收机制的语言，内存分析器也是很有用的，因为对于某个对象来说，只要有指针还指向它，那它就不会被回收。</p>
<p>下面这个例子及其输出，展示了 <a href="https://pypi.org/project/memory-profiler/" target="_blank" rel="noopener noreffer ">memory-profiler</a> 是如何工作的（注意装饰器和 <code>line-profiler</code> 类似）。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@profile
</span></span><span class="line"><span class="cl">def my_func():
</span></span><span class="line"><span class="cl">    a = [1] * (10 ** 6)
</span></span><span class="line"><span class="cl">    b = [2] * (2 * 10 ** 7)
</span></span><span class="line"><span class="cl">    del b
</span></span><span class="line"><span class="cl">    return a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">if __name__ == &#39;__main__&#39;:
</span></span><span class="line"><span class="cl">    my_func()</span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ python -m memory_profiler example.py
</span></span><span class="line"><span class="cl">Line #    Mem usage  Increment   Line Contents
</span></span><span class="line"><span class="cl">==============================================
</span></span><span class="line"><span class="cl">     3                           @profile
</span></span><span class="line"><span class="cl">     4      5.97 MB    0.00 MB   def my_func():
</span></span><span class="line"><span class="cl">     5     13.61 MB    7.64 MB       a = [1] * (10 ** 6)
</span></span><span class="line"><span class="cl">     6    166.20 MB  152.59 MB       b = [2] * (2 * 10 ** 7)
</span></span><span class="line"><span class="cl">     7     13.61 MB -152.59 MB       del b
</span></span><span class="line"><span class="cl">     8     13.61 MB    0.00 MB       return a</span></span></code></pre></div></div>
<h3 id="事件分析">事件分析</h3>
<p>在我们使用<code>strace</code>调试代码的时候，您可能会希望忽略一些特殊的代码并希望在分析时将其当作黑盒处理。<a href="http://man7.org/linux/man-pages/man1/perf.1.html" target="_blank" rel="noopener noreffer "><code>perf</code></a> 命令将 CPU 的区别进行了抽象，它不会报告时间和内存的消耗，而是报告与您的程序相关的系统事件。</p>
<p>例如，<code>perf</code> 可以报告不佳的缓存局部性（poor cache locality）、大量的页错误（page faults）或活锁（livelocks）。下面是关于常见命令的简介：</p>
<ul>
<li><code>perf list</code> - 列出可以被 pref 追踪的事件；</li>
<li><code>perf stat COMMAND ARG1 ARG2</code> - 收集与某个进程或指令相关的事件；</li>
<li><code>perf record COMMAND ARG1 ARG2</code> - 记录命令执行的采样信息并将统计数据储存在<code>perf.data</code>中；</li>
<li><code>perf report</code> - 格式化并打印 <code>perf.data</code> 中的数据。</li>
</ul>
<h3 id="可视化">可视化</h3>
<h4 id="采样分析器">采样分析器</h4>
<p>对于采样分析器来说，常见的显示 CPU 分析数据的形式是 <a href="http://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noopener noreffer ">火焰图</a>，火焰图会在 Y 轴显示函数调用关系，并在 X 轴显示其耗时的比例。火焰图同时还是可交互的，您可以深入程序的某一具体部分，并查看其栈追踪（您可以尝试点击下面的图片）。</p>
<p><a href="http://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noopener noreffer ">Flamegraphs</a> 是对采样分析器结果的可视化工具。</p>
<p>[<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://xieting-img.oss-cn-hangzhou.aliyuncs.com/cpu-bash-flamegraph.svg"
        data-srcset="https://xieting-img.oss-cn-hangzhou.aliyuncs.com/cpu-bash-flamegraph.svg, https://xieting-img.oss-cn-hangzhou.aliyuncs.com/cpu-bash-flamegraph.svg 1.5x, https://xieting-img.oss-cn-hangzhou.aliyuncs.com/cpu-bash-flamegraph.svg 2x"
        data-sizes="auto"
        alt="https://xieting-img.oss-cn-hangzhou.aliyuncs.com/cpu-bash-flamegraph.svg"
        title="FlameGraph" /></p>
<h4 id="调用图">调用图</h4>
<p>调用图和控制流图可以显示子程序之间的关系，它将函数作为节点并把函数调用作为边。将它们和分析器的信息（例如调用次数、耗时等）放在一起使用时，调用图会变得非常有用，它可以帮助我们分析程序的流程。 在 Python 中您可以使用 <a href="http://pycallgraph.slowchop.com/en/master/" target="_blank" rel="noopener noreffer "><code>pycallgraph</code></a> 来生成这些图片。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://xieting-img.oss-cn-hangzhou.aliyuncs.com/A_Call_Graph_generated_by_pycallgraph.png"
        data-srcset="https://xieting-img.oss-cn-hangzhou.aliyuncs.com/A_Call_Graph_generated_by_pycallgraph.png, https://xieting-img.oss-cn-hangzhou.aliyuncs.com/A_Call_Graph_generated_by_pycallgraph.png 1.5x, https://xieting-img.oss-cn-hangzhou.aliyuncs.com/A_Call_Graph_generated_by_pycallgraph.png 2x"
        data-sizes="auto"
        alt="https://xieting-img.oss-cn-hangzhou.aliyuncs.com/A_Call_Graph_generated_by_pycallgraph.png"
        title="Call Graph" /></p>
<p>计算斐波那契数列 Python 代码，它为计算每个数字都定义了一个函数：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1">#!/usr/bin/env python def fib0(): return 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fib1</span><span class="p">():</span> <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;def fib{}(): return fib{}() + fib{}()&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="n">exec</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># from functools import lru_cache</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># for n in range(10):</span>
</span></span><span class="line"><span class="cl">	<span class="c1">#     exec(&#34;fib{} = lru_cache(1)(fib{})&#34;.format(n, n))</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="n">eval</span><span class="p">(</span><span class="s2">&#34;fib9()&#34;</span><span class="p">))</span></span></span></code></pre></div></div>
<ol>
<li>安装<a href="http://graphviz.org/" target="_blank" rel="noopener noreffer "><code>graphviz</code></a>，<code>brew install graphviz</code> ，(如果您能够执行<code>dot</code>, 则说明已经安装了 GraphViz.)</li>
<li>安装 <a href="http://pycallgraph.slowchop.com/en/master/" target="_blank" rel="noopener noreffer "><code>pycallgraph</code></a>，<code>pip install pycallgraph</code></li>
<li>使用 <code>pycallgraph graphviz -- ./fib.py</code> 来执行代码并查看<code>pycallgraph.png</code> 这个文件。</li>
</ol>
<h2 id="资源监控">资源监控</h2>
<p>有时候，分析程序性能的第一步是搞清楚它所消耗的资源。程序变慢通常是因为它所需要的资源不够了。例如，没有足够的内存或者网络连接变慢的时候。</p>
<p>有很多很多的工具可以被用来显示不同的系统资源，例如 CPU 占用、内存使用、网络、磁盘使用等。</p>
<h3 id="通用监控">通用监控</h3>
<p>最流行的工具要数 <a href="https://htop.dev/" target="_blank" rel="noopener noreffer "><code>htop</code></a>,了，它是 <a href="http://man7.org/linux/man-pages/man1/top.1.html" target="_blank" rel="noopener noreffer "><code>top</code></a>的改进版。<code>htop</code> 可以显示当前运行进程的多种统计信息。<code>htop</code> 有很多选项和快捷键，常见的有：<code>&lt;F6&gt;</code> 进程排序、 <code>t</code> 显示树状结构和 <code>h</code> 打开或折叠线程。</p>
<p>还可以留意一下 <a href="https://nicolargo.github.io/glances/" target="_blank" rel="noopener noreffer "><code>glances</code></a> ，它的实现类似但是用户界面更好。</p>
<p>如果需要合并测量全部的进程， <a href="http://dag.wiee.rs/home-made/dstat/" target="_blank" rel="noopener noreffer "><code>dstat</code></a> 是也是一个非常好用的工具，它可以实时地计算不同子系统资源的度量数据，例如 I/O、网络、 CPU 利用率、上下文切换等等；</p>
<h3 id="io-操作">I/O 操作</h3>
<p><a href="http://man7.org/linux/man-pages/man8/iotop.8.html" target="_blank" rel="noopener noreffer "><code>iotop</code></a> 可以显示实时 I/O 占用信息而且可以非常方便地检查某个进程是否正在执行大量的磁盘读写操作；</p>
<h3 id="磁盘使用">磁盘使用</h3>
<p><a href="http://man7.org/linux/man-pages/man1/df.1.html" target="_blank" rel="noopener noreffer "><code>df</code></a> 可以显示每个分区的信息，而 <a href="http://man7.org/linux/man-pages/man1/du.1.html" target="_blank" rel="noopener noreffer "><code>du</code></a> 则可以显示当前目录下每个文件的磁盘使用情况（ <strong>d</strong>isk <strong>u</strong>sage）。<code>-h</code> 选项可以使命令以对人类（<strong>h</strong>uman）更加友好的格式显示数据；<a href="https://dev.yorhel.nl/ncdu" target="_blank" rel="noopener noreffer "><code>ncdu</code></a>是一个交互性更好的 <code>du</code> ，它可以让您在不同目录下导航、删除文件和文件夹；</p>
<h3 id="内存使用">内存使用</h3>
<p><a href="http://man7.org/linux/man-pages/man1/free.1.html" target="_blank" rel="noopener noreffer "><code>free</code></a> 可以显示系统当前空闲的内存。内存也可以使用 <code>htop</code> 这样的工具来显示；</p>
<h3 id="打开文件">打开文件</h3>
<p><a href="http://man7.org/linux/man-pages/man8/lsof.8.html" target="_blank" rel="noopener noreffer "><code>lsof</code></a> 可以列出被进程打开的文件信息。 当我们需要查看某个文件是被哪个进程打开的时候，这个命令非常有用；</p>
<p>例如，执行 <code>lsof | grep LISTEN</code> 打印出所有监听端口的进程及相应的端口。</p>
<h3 id="网络连接和配置">网络连接和配置</h3>
<p><a href="http://man7.org/linux/man-pages/man8/ss.8.html" target="_blank" rel="noopener noreffer "><code>ss</code></a> 能帮助我们监控网络包的收发情况以及网络接口的显示信息。<code>ss</code> 常见的一个使用场景是找到端口被进程占用的信息。</p>
<p>如果要显示路由、网络设备和接口信息，您可以使用 <a href="http://man7.org/linux/man-pages/man8/ip.8.html" target="_blank" rel="noopener noreffer "><code>ip</code></a> 命令。注意，<code>netstat</code> 和 <code>ifconfig</code> 这两个命令已经被前面那些工具所代替了。</p>
<h3 id="网络使用">网络使用</h3>
<p><a href="https://github.com/raboof/nethogs" target="_blank" rel="noopener noreffer "><code>nethogs</code></a> 和 <a href="http://www.ex-parrot.com/pdw/iftop/" target="_blank" rel="noopener noreffer "><code>iftop</code></a> 是非常好的用于对网络占用进行监控的交互式命令行工具。</p>
<h2 id="专用工具">专用工具</h2>
<h3 id="增加负载">增加负载</h3>
<p>如果您希望测试资源监控工具，您可以使用 <a href="https://linux.die.net/man/1/stress" target="_blank" rel="noopener noreffer "><code>stress</code></a> 命令来为系统人为地增加负载。</p>
<p>执行 <code>stress -c 3</code> 并使用<code>htop</code> 对 CPU 消耗进行可视化。</p>
<p>执行<code>taskset --cpu-list 0,2 stress -c 3</code> 并可视化，会发现限制了 CPU 负载增加的数量。</p>
<p>阅读<a href="http://man7.org/linux/man-pages/man1/taskset.1.html" target="_blank" rel="noopener noreffer "><code>man taskset</code></a>获取更多。</p>
<p><a href="http://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener noreffer "><code>cgroups</code></a> 也是一个控制系统资源的工具。</p>
<h3 id="基准测试">基准测试</h3>
<p>有时候，您只需要对黑盒程序进行基准测试，并依此对软件选择进行评估。 类似 <a href="https://github.com/sharkdp/hyperfine" target="_blank" rel="noopener noreffer "><code>hyperfine</code></a> 这样的命令行可以帮您快速进行基准测试。例如，我们在 shell 工具和脚本那一节课中我们推荐使用 <code>fd</code> 来代替 <code>find</code>。我们这里可以用<code>hyperfine</code>来比较一下它们。</p>
<p>例如，下面的例子中，我们可以看到<code>fd</code> 比 <code>find</code> 要快 20 倍。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ hyperfine --warmup 3 &#39;fd -e jpg&#39; &#39;find . -iname &#34;*.jpg&#34;&#39;
</span></span><span class="line"><span class="cl">Benchmark #1: fd -e jpg
</span></span><span class="line"><span class="cl">  Time (mean ± σ):      51.4 ms ±   2.9 ms    [User: 121.0 ms, System: 160.5 ms]
</span></span><span class="line"><span class="cl">  Range (min … max):    44.2 ms …  60.1 ms    56 runs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Benchmark #2: find . -iname &#34;*.jpg&#34;
</span></span><span class="line"><span class="cl">  Time (mean ± σ):      1.126 s ±  0.101 s    [User: 141.1 ms, System: 956.1 ms]
</span></span><span class="line"><span class="cl">  Range (min … max):    0.975 s …  1.287 s    10 runs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Summary
</span></span><span class="line"><span class="cl">  &#39;fd -e jpg&#39; ran
</span></span><span class="line"><span class="cl">   21.89 ± 2.33 times faster than &#39;find . -iname &#34;*.jpg&#34;&#39;</span></span></code></pre></div></div>
<h3 id="浏览器">浏览器</h3>
<p>和 debug 一样，浏览器也包含了很多不错的性能分析工具，可以用来分析页面加载，让我们可以搞清楚时间都消耗在什么地方（加载、渲染、脚本等等）。 更多关于 <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Performance/Profiling_with_the_Built-in_Profiler" target="_blank" rel="noopener noreffer ">Firefox</a> 和 <a href="https://developers.google.com/web/tools/chrome-devtools/rendering-tools" target="_blank" rel="noopener noreffer ">Chrome</a>的信息可以点击链接。</p>
<h3 id="抓包工具">抓包工具</h3>
<h4 id="wireshark">Wireshark</h4>
<p>让 <a href="https://www.wireshark.org/" target="_blank" rel="noopener noreffer ">Wireshark</a> 解密以 RSA 为密钥交换算法的 ssl 流量，需要给 wireshark 设置 ssl 证书私钥。 RSA 交换算法已经普遍被禁用了, 对于主流的 DH 或者 ECDH 交换算法, wireshark 无法解密。但是, 工业上的一个实际标准可以使 wireshark 解密这些 ssl 链接。</p>
<p>设置 SSLKEYLOGFILE 环境变量解密 HTTPS 流量</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 设置环境变量</span>
</span></span><span class="line"><span class="cl">touch ~/.sslkey.log
</span></span><span class="line"><span class="cl">sudo chmod <span class="m">777</span> ~/.sslkey.log
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;export SSLKEYLOGFILE=~/.sslkey.log&#34;</span> &gt;&gt; ~/.zshrc
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ~/.zshrc
</span></span><span class="line"><span class="cl"><span class="c1"># 保存私钥，运行curl会检测这个环境变量SSLKEYLOGFILE, 它指向一个文件, curl会把 DH 交换的私钥保存到这个文件里面</span>
</span></span><span class="line"><span class="cl">curl --resolve www.baidu.com:443:183.232.231.174 https://www.baidu.com
</span></span><span class="line"><span class="cl">cat ~/.sslkey.log</span></span></code></pre></div></div>
<p>配置 wireshark，打开 perferences -&gt; Protocols -&gt; TSL。配置 (Pre)-Master-Secret log filename，路径为上述 .sslkey.log 的全路径。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-12-10</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2022-12-10-profile/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on X" data-sharer="x" data-url="https://austinxt.github.io/2022-12-10-profile/" data-title="常用性能分析工具" data-hashtags="性能分析"><i class="fab fa-x-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Threads" data-sharer="threads" data-url="https://austinxt.github.io/2022-12-10-profile/" data-title="常用性能分析工具"><i class="fab fa-threads fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://austinxt.github.io/2022-12-10-profile/" data-hashtag="性能分析"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://austinxt.github.io/2022-12-10-profile/" data-title="常用性能分析工具"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://austinxt.github.io/2022-12-10-profile/" data-title="常用性能分析工具"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://austinxt.github.io/2022-12-10-profile/" data-title="常用性能分析工具"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Diaspora" data-sharer="diaspora" data-url="https://austinxt.github.io/2022-12-10-profile/" data-title="常用性能分析工具" data-description=""><i class="fab fa-diaspora fa-fw" aria-hidden="true"></i></a><a href="https://t.me/share/url?url=https%3a%2f%2faustinxt.github.io%2f2022-12-10-profile%2f&amp;text=%e5%b8%b8%e7%94%a8%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%b7%a5%e5%85%b7" target="_blank" title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">性能分析</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022-11-12-shell/" class="prev" rel="prev" title="Shell 工具和脚本入门"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Shell 工具和脚本入门</a>
            <a href="/2023-01-11-data-analysis/" class="next" rel="next" title="Shell 命令行数据处理">Shell 命令行数据处理<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.148.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://blog.nightvoyager.top/" target="_blank">夜航星</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/copy-tex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/mhchem.min.js"></script><script>window.config={"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
